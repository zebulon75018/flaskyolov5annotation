<!DOCTYPE html>
<html>
<head>
    <title>Image Gallery</title>
    <style>
        #container {
            display: flex;
            flex-direction: row;
        }

        #imageList {
            width: 200px;
            height: 800px;
            overflow-y: scroll;
        }

        #canvas {
            flex: 1;
            border: 1px solid black;
        }
    </style>
  <script src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/fabric.js/2.1.0/fabric.min.js"></script>

</head>
<body>
    <div id="container">
        <div id="imageList">
            {% for img in lstimg %}
            <img src="/static/{{img}}" width="100px" onclick="displayImage('/static/{{img}}')">
            {% endfor %}
            <!-- Add more images here -->
        </div>
        <canvas id="canvas"></canvas>
        <button onclick="savefunc()">Save</button>
    </div>

    <script>
  var canvas = new fabric.Canvas("canvas", {
    //isDrawingMode: true,
    //skipTargetFind: true,
    //selectable: false,
    //selection: false
    width : 832,
    height : 832,
  });
   var rects = [];
   var filenamepix ="";
   var imgw = 0;
   var imgh = 0;

        function savefunc() {
            console.log(rects);
            console.log("savefunc");
            robj = [] 
            for (var i = 0; i < rects.length; i++) {
                 robj.push({"left":rects[i].left,"top":rects[i].top,"width": rects[i].width, "height": rects[i].height, "label": rects[i].label });

            }
            $.post("/save/",
             {
             filenamepix: filenamepix,
             rects: JSON.stringify(robj),
             w: imgw,
             h: imgh,
            },
             function(data, status){
               console.log(" savefunc ");
           });
        }
        function displayImage(imageSrc) {

          filenamepix =imageSrc;
      fabric.Image.fromURL(imageSrc, function(img) {
         canvas.clear();
         rects = [];
         // add background image

         imgw = img.width;
         imgh = img.height;
         console.log(img.width);
         console.log(img.height);
         canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height
         });
        $.get("/data?filename="+imageSrc, function(data, status){
              data.forEach(function(item) {
                var label = item.label;
                var bbox = item.bbox;

                var rect = new fabric.Rect({
                    left: bbox[0]*canvas.width,
                    top: bbox[1]*canvas.height,
                    width: (bbox[2] - bbox[0])*canvas.width,
                    height: (bbox[3] - bbox[1])*canvas.height,
                    fill: 'transparent',
                    stroke: 'red',
                    strokeWidth: 2,
                    label:  label
                });
                rects.push(rect);

                canvas.add(rect);

                // Display label as text above the rectangle
                var text = new fabric.Text(label, {
                    left: bbox[0]*canvas.width,
                    top: bbox[1]*canvas.height - 20,
                    fontSize: 16,
                    fill: 'red'
                });

                canvas.add(text);
            });

            canvas.renderAll();
               });
      });
        }
    </script>
</body>
</html>
